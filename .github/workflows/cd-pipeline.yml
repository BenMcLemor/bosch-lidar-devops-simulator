name: CD - Docker and Deploy

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]

jobs:
  build-docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: ${{ secrets.DOCKER_USERNAME }}/bosch-lidar-calibration
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-
        
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        
    - name: Test Docker Image
      run: |
        echo "üß™ Testing Docker image..."
        docker pull ${{ secrets.DOCKER_USERNAME }}/bosch-lidar-calibration:main
        docker run --rm ${{ secrets.DOCKER_USERNAME }}/bosch-lidar-calibration:main
        
  deploy-preview:
    name: Deploy to Preview
    needs: build-docker
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Deploy to Kubernetes (Preview)
      run: |
        echo "üöÄ Deploying preview to Kubernetes..."
        echo "This would deploy to a preview environment"
        echo "Image: ${{ secrets.DOCKER_USERNAME }}/bosch-lidar-calibration:${{ github.sha }}"
        
  deploy-production:
    name: Deploy to Production
    needs: build-docker
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Set up Kubernetes
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'
        
    - name: Configure Kubernetes
      run: |
        echo "‚öôÔ∏è  Configuring Kubernetes..."
        # In production, you would set up kubeconfig from secrets
        # For demo, we'll just simulate
        
    - name: Deploy to Kubernetes
      run: |
        echo "üöÄ Simulating Kubernetes deployment..."
        echo "Would deploy: ${{ secrets.DOCKER_USERNAME }}/bosch-lidar-calibration:${{ github.sha }}"
        echo ""
        echo "Commands that would run:"
        echo "kubectl set image deployment/lidar-calibration \\"
        echo "  lidar-calibrator=${{ secrets.DOCKER_USERNAME }}/bosch-lidar-calibration:${{ github.sha }}"
        echo ""
        echo "‚úÖ Deployment simulated successfully!"